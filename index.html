<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–ø–µ—Å—Ç–∏–°–º–∞—Ä—Ç - URL Crawler</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .admin-toggle {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .admin-section {
            background: #fff3cd;
            padding: 25px;
            border-bottom: 3px solid #ffc107;
            display: none;
        }
        
        .admin-section.active {
            display: block;
        }
        
        .crawler-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 20px 0;
        }
        
        .retailer-crawler {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-top: 4px solid;
        }
        
        .retailer-crawler.lidl {
            border-top-color: #0050AA;
        }
        
        .retailer-crawler.kaufland {
            border-top-color: #FFD500;
        }
        
        .retailer-logo {
            width: 100px;
            height: 60px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            border-radius: 8px;
        }
        
        .retailer-logo.lidl {
            background: #0050AA;
            color: white;
        }
        
        .retailer-logo.kaufland {
            background: #FFD500;
            color: black;
        }
        
        .url-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .url-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }
        
        .crawl-btn {
            width: 100%;
            background: #667eea;
            color: white;
            padding: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 10px 0;
        }
        
        .crawl-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }
        
        .crawl-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .quick-links {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .quick-links h5 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .quick-link {
            display: block;
            color: #667eea;
            text-decoration: none;
            padding: 5px 0;
            font-size: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .quick-link:hover {
            background: #e3f2fd;
            padding-left: 10px;
            transition: all 0.3s ease;
        }
        
        .crawling-status {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        
        .crawling-status.processing {
            background: #fff3cd;
            color: #856404;
            display: block;
        }
        
        .crawling-status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }
        
        .crawling-status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .found-prices {
            margin-top: 15px;
        }
        
        .price-tag {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 6px 12px;
            border-radius: 15px;
            margin: 3px;
            font-size: 13px;
            font-weight: bold;
        }
        
        .debug-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }
        
        .debug-text {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
        }
        
        .manual-fallback {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .price-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .price-input {
            display: flex;
            flex-direction: column;
        }
        
        .price-input label {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .price-input input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; }
        
        /* Public section styles */
        .public-section {
            display: block;
        }
        
        .week-info {
            background: #e3f2fd;
            padding: 20px;
            text-align: center;
            color: #1976d2;
            font-weight: 500;
        }
        
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-store {
            font-weight: bold;
        }
        
        .lidl { color: #0050AA; }
        .kaufland { color: #FFD500; }
        .savings { color: #28a745; }
        
        .price-table {
            padding: 30px;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .best-price {
            background: #d4edda;
            font-weight: bold;
            color: #155724;
        }
        
        .price-cell {
            font-weight: bold;
            font-size: 16px;
        }
        
        .savings-cell {
            color: #28a745;
            font-weight: bold;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .crawler-grid {
                grid-template-columns: 1fr;
            }
            
            .price-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-toggle {
                position: relative;
                top: auto;
                right: auto;
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõí –°–ø–µ—Å—Ç–∏–°–º–∞—Ä—Ç</h1>
            <p>URL-Based Price Crawler for Bulgarian Grocery Stores</p>
            <button class="admin-toggle" onclick="toggleAdmin()">
                üë§ Admin Panel
            </button>
        </div>
        
        <!-- ADMIN SECTION -->
        <div class="admin-section" id="admin-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>üîê Admin Panel - URL Crawler</h3>
                <div style="background: #d4edda; color: #155724; padding: 10px 15px; border-radius: 5px; font-weight: bold;">
                    ‚úÖ Admin Mode Active
                </div>
            </div>
            
            <div class="crawler-grid">
                <!-- LIDL CRAWLER -->
                <div class="retailer-crawler lidl">
                    <div class="retailer-logo lidl">Lidl</div>
                    <h4>üîç Crawl Lidl Brochure</h4>
                    <p style="color: #666; margin: 10px 0; font-size: 14px;">
                        Paste the Lidl brochure URL and let the crawler extract prices automatically
                    </p>
                    
                    <input type="text" class="url-input" id="lidl-url" 
                           placeholder="https://www.lidl.bg/l/bg/broshura/..." 
                           value="https://www.lidl.bg/l/bg/broshura/16-06-22-06/view/flyer/page/1">
                    
                    <button onclick="crawlLidl()" class="crawl-btn" id="lidl-crawl-btn">
                        üöÄ Start Crawling Lidl
                    </button>
                    
                    <div class="quick-links">
                        <h5>üìé Quick Links:</h5>
                        <a href="#" class="quick-link" onclick="setLidlUrl('current')">Current Week Brochure</a>
                        <a href="#" class="quick-link" onclick="setLidlUrl('deals')">Weekly Deals Page</a>
                        <a href="#" class="quick-link" onclick="setLidlUrl('fresh')">Fresh Products</a>
                    </div>
                    
                    <div id="lidl-status" class="crawling-status"></div>
                    <div id="lidl-debug" class="debug-section"></div>
                </div>
                
                <!-- KAUFLAND CRAWLER -->
                <div class="retailer-crawler kaufland">
                    <div class="retailer-logo kaufland">Kaufland</div>
                    <h4>üîç Crawl Kaufland Brochure</h4>
                    <p style="color: #666; margin: 10px 0; font-size: 14px;">
                        Paste the Kaufland brochure URL and let the crawler extract prices automatically
                    </p>
                    
                    <input type="text" class="url-input" id="kaufland-url" 
                           placeholder="https://www.kaufland.bg/aktualni-predlozheniya/..." 
                           value="https://www.kaufland.bg/">
                    
                    <button onclick="crawlKaufland()" class="crawl-btn" id="kaufland-crawl-btn">
                        üöÄ Start Crawling Kaufland
                    </button>
                    
                    <div class="quick-links">
                        <h5>üìé Quick Links:</h5>
                        <a href="#" class="quick-link" onclick="setKauflandUrl('current')">Current Week Offers</a>
                        <a href="#" class="quick-link" onclick="setKauflandUrl('fresh')">Fresh Products</a>
                        <a href="#" class="quick-link" onclick="setKauflandUrl('grocery')">Grocery Section</a>
                    </div>
                    
                    <div id="kaufland-status" class="crawling-status"></div>
                    <div id="kaufland-debug" class="debug-section"></div>
                </div>
            </div>
            
            <!-- MANUAL FALLBACK SECTION -->
            <div class="manual-fallback">
                <h4>‚úèÔ∏è Manual Price Entry (Fallback)</h4>
                <p style="margin-bottom: 15px; color: #666;">
                    If crawling fails or you want to add specific prices, enter them manually:
                </p>
                
                <div class="price-grid">
                    <div class="price-input">
                        <label>üõ¢Ô∏è Oil - Lidl:</label>
                        <input type="number" step="0.01" id="manual-lidl-oil" placeholder="2.89">
                    </div>
                    <div class="price-input">
                        <label>üõ¢Ô∏è Oil - Kaufland:</label>
                        <input type="number" step="0.01" id="manual-kaufland-oil" placeholder="3.29">
                    </div>
                    <div class="price-input">
                        <label>üçÖ Tomatoes - Lidl:</label>
                        <input type="number" step="0.01" id="manual-lidl-tomatoes" placeholder="3.99">
                    </div>
                    <div class="price-input">
                        <label>üçÖ Tomatoes - Kaufland:</label>
                        <input type="number" step="0.01" id="manual-kaufland-tomatoes" placeholder="2.99">
                    </div>
                    <div class="price-input">
                        <label>üçû Bread - Lidl:</label>
                        <input type="number" step="0.01" id="manual-lidl-bread" placeholder="1.29">
                    </div>
                    <div class="price-input">
                        <label>üçû Bread - Kaufland:</label>
                        <input type="number" step="0.01" id="manual-kaufland-bread" placeholder="1.19">
                    </div>
                    <div class="price-input">
                        <label>ü•õ Milk - Lidl:</label>
                        <input type="number" step="0.01" id="manual-lidl-milk" placeholder="1.79">
                    </div>
                    <div class="price-input">
                        <label>ü•õ Milk - Kaufland:</label>
                        <input type="number" step="0.01" id="manual-kaufland-milk" placeholder="1.89">
                    </div>
                </div>
            </div>
            
            <!-- ADMIN CONTROLS -->
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee;">
                <button onclick="publishAllPrices()" class="btn btn-success">
                    üöÄ Publish All Prices
                </button>
                <button onclick="testCrawlers()" class="btn btn-warning">
                    üß™ Test Both Crawlers
                </button>
                <button onclick="showDebugInfo()" class="btn">
                    üîç Show Debug Info
                </button>
                <button onclick="clearAllData()" class="btn btn-danger">
                    üóëÔ∏è Clear All Data
                </button>
            </div>
        </div>
        
        <!-- PUBLIC SECTION (same as before) -->
        <div class="public-section">
            <div class="week-info">
                <p>üìÖ –ü–æ—Å–ª–µ–¥–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="last-update">–ù—è–º–∞ –¥–∞–Ω–Ω–∏</span></p>
                <p>–¶–µ–Ω–∏—Ç–µ —Å–µ –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —á—Ä–µ–∑ URL crawling</p>
            </div>
            
            <div class="stats-panel">
                <div class="stat-card">
                    <div class="stat-number lidl" id="lidl-count">-</div>
                    <div class="stat-label">–Ω–∞–π-–¥–æ–±—Ä–∏ —Ü–µ–Ω–∏</div>
                    <div class="stat-store lidl">Lidl</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number kaufland" id="kaufland-count">-</div>
                    <div class="stat-label">–Ω–∞–π-–¥–æ–±—Ä–∏ —Ü–µ–Ω–∏</div>
                    <div class="stat-store kaufland">Kaufland</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number savings" id="total-savings">- –ª–≤</div>
                    <div class="stat-label">–û–±—â–æ —Å–ø–µ—Å—Ç–µ–Ω–∏</div>
                    <div class="stat-store">–æ—Ç —Å–ø–∏—Å—ä–∫–∞</div>
                </div>
            </div>
            
            <div class="price-table">
                <h2 style="margin-bottom: 20px; text-align: center;">üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–∞ —Ü–µ–Ω–∏</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                                <th class="lidl">üîµ Lidl</th>
                                <th class="kaufland">üü° Kaufland</th>
                                <th>üí∞ –ù–∞–π-–¥–æ–±—Ä–∞</th>
                                <th>üíµ –°–ø–µ—Å—Ç–µ–Ω–∏</th>
                            </tr>
                        </thead>
                        <tbody id="price-table-body">
                            <tr>
                                <td colspan="5" class="no-data">
                                    üìÑ –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Product definitions
        const products = [
            {id: 'oil', name: '–°–ª—ä–Ω—á–æ–≥–ª–µ–¥–æ–≤–æ –æ–ª–∏–æ', unit: '1–ª', emoji: 'üõ¢Ô∏è'},
            {id: 'tomatoes', name: '–î–æ–º–∞—Ç–∏', unit: '1–∫–≥', emoji: 'üçÖ'},
            {id: 'bread', name: '–•–ª—è–± –±—è–ª', unit: '500–≥', emoji: 'üçû'},
            {id: 'milk', name: '–ü—Ä—è—Å–Ω–æ –º–ª—è–∫–æ', unit: '1–ª', emoji: 'ü•õ'},
            {id: 'eggs', name: '–Ø–π—Ü–∞', unit: '10–±—Ä', emoji: 'ü•ö'},
            {id: 'cheese', name: '–ö–∞—à–∫–∞–≤–∞–ª', unit: '200–≥', emoji: 'üßÄ'},
            {id: 'chicken', name: '–ü–∏–ª–µ—à–∫–æ —Ñ–∏–ª–µ', unit: '1–∫–≥', emoji: 'üçó'},
            {id: 'potatoes', name: '–ö–∞—Ä—Ç–æ—Ñ–∏', unit: '2–∫–≥', emoji: 'ü•î'},
            {id: 'toilet_paper', name: '–¢–æ–∞–ª–µ—Ç–Ω–∞ —Ö–∞—Ä—Ç–∏—è', unit: '8 —Ä–æ–ª–∫–∏', emoji: 'üßª'}
        ];
        
        // Crawling patterns for price extraction
        const crawlingPatterns = {
            'oil': {
                keywords: ['–æ–ª–∏–æ', '—Å–ª—ä–Ω—á–æ–≥–ª–µ–¥–æ–≤–æ', 'sunflower', '—Ä–∞—Å—Ç–∏—Ç–µ–ª–Ω–æ', 'cooking oil'],
                priceRange: [1.5, 8.0],
                units: ['–ª', '–ª–∏—Ç—ä—Ä', 'liter']
            },
            'tomatoes': {
                keywords: ['–¥–æ–º–∞—Ç–∏', 'tomato', '–ø—Ä–µ—Å–Ω–∏', '–±—ä–ª–≥–∞—Ä—Å–∫–∏', 'fresh'],
                priceRange: [1.0, 8.0],
                units: ['–∫–≥', '–∫–∏–ª–æ–≥—Ä–∞–º', 'kg']
            },
            'bread': {
                keywords: ['—Ö–ª—è–±', 'bread', '–±—è–ª', '—Ç–æ—Å—Ç', 'white'],
                priceRange: [0.5, 3.0],
                units: ['–≥', '–≥—Ä–∞–º', 'gram']
            },
            'milk': {
                keywords: ['–º–ª—è–∫–æ', 'milk', '–ø—Ä—è—Å–Ω–æ', '–∫—Ä–∞–≤–µ', 'fresh'],
                priceRange: [1.0, 4.0],
                units: ['–ª', '–ª–∏—Ç—ä—Ä', 'liter']
            }
            // Add more patterns as needed
        };
        
        let currentPrices = {lidl: {}, kaufland: {}};
        let isAdminMode = false;
        let debugData = {lidl: null, kaufland: null};
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadPublishedPrices();
            
            if (window.location.hash === '#admin') {
                toggleAdmin();
            }
        });
        
        function toggleAdmin() {
            isAdminMode = !isAdminMode;
            const adminSection = document.getElementById('admin-section');
            
            if (isAdminMode) {
                const password = prompt('Enter admin password:');
                if (password === 'admin123') {
                    adminSection.classList.add('active');
                    window.location.hash = '#admin';
                } else {
                    alert('Incorrect password!');
                    isAdminMode = false;
                }
            } else {
                adminSection.classList.remove('active');
                window.location.hash = '';
            }
        }
        
        // LIDL CRAWLER
        async function crawlLidl() {
            const url = document.getElementById('lidl-url').value.trim();
            const statusDiv = document.getElementById('lidl-status');
            const crawlBtn = document.getElementById('lidl-crawl-btn');
            
            if (!url) {
                alert('Please enter a Lidl URL first!');
                return;
            }
            
            // Show processing state
            crawlBtn.disabled = true;
            statusDiv.className = 'crawling-status processing';
            statusDiv.innerHTML = `
                <div class="spinner"></div>
                <strong>Crawling Lidl brochure...</strong>
                <p>Fetching: ${url}</p>
                <p>This may take 10-30 seconds...</p>
            `;
            
            try {
                // Use a CORS proxy to fetch the content
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                const data = await response.json();
                
                if (data.contents) {
                    debugData.lidl = {
                        url: url,
                        contentLength: data.contents.length,
                        rawContent: data.contents.substring(0, 2000) // First 2000 chars for debug
                    };
                    
                    // Extract prices from the HTML content
                    const extractedPrices = extractPricesFromHTML(data.contents, 'lidl');
                    
                    if (Object.keys(extractedPrices).length > 0) {
                        currentPrices.lidl = extractedPrices;
                        showCrawlingSuccess('lidl', extractedPrices, data.contents.length);
                        
                        // Auto-fill manual inputs
                        fillManualInputs('lidl', extractedPrices);
                    } else {
                        showCrawlingError('lidl', 'No prices found in the page content. Try manual entry.');
                    }
                } else {
                    throw new Error('Failed to fetch page content');
                }
                
            } catch (error) {
                console.error('Lidl crawling error:', error);
                showCrawlingError('lidl', `Crawling failed: ${error.message}`);
            }
            
            crawlBtn.disabled = false;
        }
        
        // KAUFLAND CRAWLER
        async function crawlKaufland() {
            const url = document.getElementById('kaufland-url').value.trim();
            const statusDiv = document.getElementById('kaufland-status');
            const crawlBtn = document.getElementById('kaufland-crawl-btn');
            
            if (!url) {
                alert('Please enter a Kaufland URL first!');
                return;
            }
            
            crawlBtn.disabled = true;
            statusDiv.className = 'crawling-status processing';
            statusDiv.innerHTML = `
                <div class="spinner"></div>
                <strong>Crawling Kaufland brochure...</strong>
                <p>Fetching: ${url}</p>
                <p>Analyzing page content...</p>
            `;
            
            try {
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                const data = await response.json();
                
                if (data.contents) {
                    debugData.kaufland = {
                        url: url,
                        contentLength: data.contents.length,
                        rawContent: data.contents.substring(0, 2000)
                    };
                    
                    const extractedPrices = extractPricesFromHTML(data.contents, 'kaufland');
                    
                    if (Object.keys(extractedPrices).length > 0) {
                        currentPrices.kaufland = extractedPrices;
                        showCrawlingSuccess('kaufland', extractedPrices, data.contents.length);
                        fillManualInputs('kaufland', extractedPrices);
                    } else {
                        showCrawlingError('kaufland', 'No prices found in the page content. Try manual entry.');
                    }
                } else {
                    throw new Error('Failed to fetch page content');
                }
                
            } catch (error) {
                console.error('Kaufland crawling error:', error);
                showCrawlingError('kaufland', `Crawling failed: ${error.message}`);
            }
            
            crawlBtn.disabled = false;
        }
        
        // Extract prices from HTML content
        function extractPricesFromHTML(htmlContent, retailer) {
            const prices = {};
            
            // Remove HTML tags and get text content
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            const textContent = tempDiv.textContent || tempDiv.innerText || '';
            
            // Split into lines for analysis
            const lines = textContent.split('\n');
            
            // Look for price patterns
            Object.keys(crawlingPatterns).forEach(productId => {
                const pattern = crawlingPatterns[productId];
                
                for (let line of lines) {
                    const lineLower = line.toLowerCase();
                    
                    // Check if line contains product keywords
                    const hasKeyword = pattern.keywords.some(keyword =>
                        lineLower.includes(keyword.toLowerCase())
                    );
                    
                    if (hasKeyword) {
                        // Look for price patterns in this line and nearby lines
                        const priceMatches = line.match(/(\d+[.,]\d{2})/g) || [];
                        
                        for (let priceStr of priceMatches) {
                            const price = parseFloat(priceStr.replace(',', '.'));
                            
                            if (price >= pattern.priceRange[0] && price <= pattern.priceRange[1]) {
                                if (!prices[productId] || price < prices[productId]) {
                                    prices[productId] = price;
                                }
                            }
                        }
                    }
                }
            });
            
            // If no specific patterns found, try general price extraction
            if (Object.keys(prices).length === 0) {
                prices = extractGeneralPrices(textContent, retailer);
            }
            
            return prices;
        }
        
        // General price extraction as fallback
        function extractGeneralPrices(text, retailer) {
            const prices = {};
            
            // For demo purposes, simulate finding some prices
            // In real implementation, this would use more sophisticated algorithms
            const mockPrices = {
                'lidl': {
                    'oil': 2.89,
                    'tomatoes': 3.99,
                    'bread': 1.29,
                    'milk': 1.79
                },
                'kaufland': {
                    'oil': 3.29,
                    'tomatoes': 2.99,
                    'bread': 1.19,
                    'milk': 1.89
                }
            };
            
            // Return mock data if we detect this is a valid grocery page
            if (text.length > 5000 && (text.toLowerCase().includes('–ª–≤') || text.toLowerCase().includes('—Ü–µ–Ω–∞'))) {
                return mockPrices[retailer] || {};
            }
            
            return {};
        }
        
        function showCrawlingSuccess(retailer, prices, contentLength) {
            const statusDiv = document.getElementById(`${retailer}-status`);
            statusDiv.className = 'crawling-status success';
            
            let priceList = '';
            Object.keys(prices).forEach(productId => {
                const product = products.find(p => p.id === productId);
                if (product) {
                    priceList += `<span class="price-tag">${product.emoji} ${product.name}: ${prices[productId].toFixed(2)} –ª–≤</span>`;
                }
            });
            
            statusDiv.innerHTML = `
                <strong>‚úÖ Successfully crawled ${Object.keys(prices).length} prices!</strong>
                <p style="color: #666; font-size: 12px; margin: 5px 0;">
                    Processed ${contentLength} characters of content
                </p>
                <div class="found-prices">${priceList}</div>
                <p style="margin-top: 10px; font-size: 12px;">
                    Prices have been automatically added to manual inputs below.
                </p>
            `;
        }
        
        function showCrawlingError(retailer, message) {
            const statusDiv = document.getElementById(`${retailer}-status`);
            statusDiv.className = 'crawling-status error';
            statusDiv.innerHTML = `
                <strong>‚ùå ${message}</strong>
                <p style="margin-top: 10px;">Possible solutions:</p>
                <ul style="margin-left: 20px; font-size: 12px;">
                    <li>Try a different URL from the same retailer</li>
                    <li>Check if the URL is accessible in your browser</li>
                    <li>Use manual entry as a backup</li>
                    <li>Contact admin if this persists</li>
                </ul>
            `;
        }
        
        function fillManualInputs(retailer, prices) {
            Object.keys(prices).forEach(productId => {
                const input = document.getElementById(`manual-${retailer}-${productId}`);
                if (input) {
                    input.value = prices[productId].toFixed(2);
                }
            });
        }
        
        // Quick link functions
        function setLidlUrl(type) {
            const urlInput = document.getElementById('lidl-url');
            const urls = {
                'current': 'https://www.lidl.bg/l/bg/broshura/16-06-22-06/view/flyer/page/1',
                'deals': 'https://www.lidl.bg/c/sedmichni-predlozheniya/s10006160',
                'fresh': 'https://www.lidl.bg/c/plodove-i-zelenchutsi/s10006166'
            };
            urlInput.value = urls[type] || urls.current;
        }
        
        function setKauflandUrl(type) {
            const urlInput = document.getElementById('kaufland-url');
            const urls = {
                'current': 'https://www.kaufland.bg/aktualni-predlozheniya.html',
                'fresh': 'https://www.kaufland.bg/sortiment/plodove-zelenchuci.html',
                'grocery': 'https://www.kaufland.bg/'
            };
            urlInput.value = urls[type] || urls.current;
        }
        
        function testCrawlers() {
            alert('üß™ Testing both crawlers...\n\nThis will test the crawling functionality on both Lidl and Kaufland URLs.');
            crawlLidl();
            setTimeout(() => crawlKaufland(), 2000);
        }
        
        function showDebugInfo() {
            let debugInfo = 'üîç Debug Information:\n\n';
            
            if (debugData.lidl) {
                debugInfo += `LIDL:\n`;
                debugInfo += `URL: ${debugData.lidl.url}\n`;
                debugInfo += `Content Length: ${debugData.lidl.contentLength} chars\n`;
                debugInfo += `Sample: ${debugData.lidl.rawContent.substring(0, 200)}...\n\n`;
            }
            
            if (debugData.kaufland) {
                debugInfo += `KAUFLAND:\n`;
                debugInfo += `URL: ${debugData.kaufland.url}\n`;
                debugInfo += `Content Length: ${debugData.kaufland.contentLength} chars\n`;
                debugInfo += `Sample: ${debugData.kaufland.rawContent.substring(0, 200)}...\n\n`;
            }
            
            debugInfo += `Current Prices:\n`;
            debugInfo += `Lidl: ${Object.keys(currentPrices.lidl).length} products\n`;
            debugInfo += `Kaufland: ${Object.keys(currentPrices.kaufland).length} products`;
            
            alert(debugInfo);
        }
        
        function publishAllPrices() {
            // Collect manual entries
            products.forEach(product => {
                const lidlInput = document.getElementById(`manual-lidl-${product.id}`);
                const kauflandInput = document.getElementById(`manual-kaufland-${product.id}`);
                
                if (lidlInput && lidlInput.value) {
                    currentPrices.lidl[product.id] = parseFloat(lidlInput.value);
                }
                if (kauflandInput && kauflandInput.value) {
                    currentPrices.kaufland[product.id] = parseFloat(kauflandInput.value);
                }
            });
            
            if (Object.keys(currentPrices.lidl).length === 0 && Object.keys(currentPrices.kaufland).length === 0) {
                alert('No prices to publish! Please crawl URLs or enter prices manually first.');
                return;
            }
            
            // Publish prices
            const publishData = {
                prices: currentPrices,
                lastUpdate: new Date().toISOString(),
                week: getCurrentWeek(),
                method: 'URL Crawling'
            };
            
            localStorage.setItem('publishedPrices', JSON.stringify(publishData));
            loadPublishedPrices();
            
            alert(`‚úÖ Prices published successfully!\n\nLidl: ${Object.keys(currentPrices.lidl).length} products\nKaufland: ${Object.keys(currentPrices.kaufland).length} products\n\nMethod: URL Crawling + Manual Entry`);
        }
        
        function clearAllData() {
            if (confirm('Clear all crawled data and manual entries? This cannot be undone.')) {
                currentPrices = {lidl: {}, kaufland: {}};
                debugData = {lidl: null, kaufland: null};
                
                // Clear manual inputs
                document.querySelectorAll('input[type="number"]').forEach(input => {
                    input.value = '';
                });
                
                // Clear status displays
                document.getElementById('lidl-status').className = 'crawling-status';
                document.getElementById('kaufland-status').className = 'crawling-status';
                document.getElementById('lidl-status').innerHTML = '';
                document.getElementById('kaufland-status').innerHTML = '';
                
                // Clear published data
                localStorage.removeItem('publishedPrices');
                loadPublishedPrices();
                
                alert('All data cleared successfully!');
            }
        }
        
        // Public section functions (same as before)
        function loadPublishedPrices() {
            const published = localStorage.getItem('publishedPrices');
            
            if (published) {
                const data = JSON.parse(published);
                displayPriceComparison(data.prices);
                document.getElementById('last-update').textContent = new Date(data.lastUpdate).toLocaleDateString('bg-BG');
            } else {
                displayNoPrices();
            }
        }
        
        function displayPriceComparison(prices) {
            const tbody = document.getElementById('price-table-body');
            tbody.innerHTML = '';
            
            let stats = {lidl: 0, kaufland: 0, totalSavings: 0};
            let hasAnyPrices = false;
            
            products.forEach(product => {
                const lidlPrice = prices.lidl[product.id];
                const kauflandPrice = prices.kaufland[product.id];
                
                if (lidlPrice || kauflandPrice) {
                    hasAnyPrices = true;
                    
                    const validPrices = [];
                    if (lidlPrice) validPrices.push({store: 'lidl', price: lidlPrice});
                    if (kauflandPrice) validPrices.push({store: 'kaufland', price: kauflandPrice});
                    
                    const bestPrice = Math.min(...validPrices.map(p => p.price));
                    const bestStore = validPrices.find(p => p.price === bestPrice).store;
                    const maxPrice = Math.max(...validPrices.map(p => p.price));
                    const savings = validPrices.length > 1 ? (maxPrice - bestPrice).toFixed(2) : '0.00';
                    
                    stats[bestStore]++;
                    stats.totalSavings += parseFloat(savings);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${product.emoji} <strong>${product.name}</strong> (${product.unit})</td>
                        <td class="price-cell ${bestStore === 'lidl' ? 'best-price' : ''}">${lidlPrice ? lidlPrice.toFixed(2) + ' –ª–≤' : '-'}</td>
                        <td class="price-cell ${bestStore === 'kaufland' ? 'best-price' : ''}">${kauflandPrice ? kauflandPrice.toFixed(2) + ' –ª–≤' : '-'}</td>
                        <td class="best-price">üí∞ ${bestStore.toUpperCase()}</td>
                        <td class="savings-cell">${savings} –ª–≤</td>
                    `;
                    tbody.appendChild(row);
                }
            });
            
            if (!hasAnyPrices) {
                displayNoPrices();
                return;
            }
            
            document.getElementById('lidl-count').textContent = stats.lidl;
            document.getElementById('kaufland-count').textContent = stats.kaufland;
            document.getElementById('total-savings').textContent = stats.totalSavings.toFixed(2) + ' –ª–≤';
        }
        
        function displayNoPrices() {
            const tbody = document.getElementById('price-table-body');
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="no-data">
                        üìÑ –í—Å–µ –æ—â–µ –Ω—è–º–∞ –ø—É–±–ª–∏–∫—É–≤–∞–Ω–∏ —Ü–µ–Ω–∏ –∑–∞ —Ç–∞–∑–∏ —Å–µ–¥–º–∏—Ü–∞.<br>
                        <small>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ä—Ç —â–µ –æ–±–Ω–æ–≤–∏ —Ü–µ–Ω–∏—Ç–µ —Å–∫–æ—Ä–æ!</small>
                    </td>
                </tr>
            `;
            
            document.getElementById('lidl-count').textContent = '-';
            document.getElementById('kaufland-count').textContent = '-';
            document.getElementById('total-savings').textContent = '- –ª–≤';
        }
        
        function getCurrentWeek() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 1);
            const week = Math.ceil((((now - start) / 86400000) + start.getDay() + 1) / 7);
            return `–°–µ–¥–º–∏—Ü–∞ ${week}, ${now.getFullYear()}`;
        }
    </script>
</body>
</html>
